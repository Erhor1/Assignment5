<!DOCTYPE html>
<html lang="en" dir="ltr">
    <head>
        <meta charset="utf-8">
        <title>Iteration 1</title>
        <script src="/socket.io/socket.io.js"></script>
        <script src="/siofu/client.js"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io-stream/0.9.1/socket.io-stream.js"></script>
    </head>
    <body>
        <p>Upload an image</p><br>
        <label>Upload File: <input type="file" id="siofu_input" /></label>
        <br>
        <button id="my_button">Upload File</button>
        <br>
        <p id="uploadProgress"></p>
        <p>Image Properties:</p>
        <p id="datainfo"></p>
        <p id="listen">Audio:</p>
        <audio id="player" controls><source src="" type="audio/wav"></audio>
        <p id="repeat"></p>
      
        <script>
            var socket = io.connect(); //connect to server socket
            var progress = document.getElementById("uploadProgress");
            var listen = document.getElementById("listen");
            var uploader = new SocketIOFileUpload(socket);
          
            uploader.listenOnSubmit(document.getElementById("my_button"), document.getElementById("siofu_input"));

            uploader.addEventListener("start", function(event){
                console.log('Started upload');
                listen.innerHTML='';
                document.getElementById("datainfo").innerHTML='';
            });

            uploader.addEventListener("progress", function(event){
                var percent = event.bytesLoaded / event.file.size * 100;
                progress.innerHTML = "File is " + percent.toFixed(2) + " percent loaded";
            });

            uploader.addEventListener("complete", function(event){
                progress.innerHTML = "File successfully uploaded";
                console.log('Finished upload');
            });

            socket.on("Finish processing", function(data){
                console.log('Sound file finished processing');
                listen.innerHTML=  'Audio ready...';
            });  
            
            socket.on('Info',function(data){
                console.log('Image Properties' + data);
                document.getElementById('datainfo').innerHTML = data;
            })
            
            ss(socket).on('audiostream', function(stream, data) {
                //Using https://github.com/zoutepopcorn/audio_socket/tree/master example
                var audio = document.getElementById('player');
                parts = []; //Buffer
                stream.on('data', function(chunk){
                    parts.push(chunk);
                });
                
                stream.on('end', function () {
                    console.log('Completed stream. Playing...');
                    audio.src = (window.URL || window.webkitURL).createObjectURL(new Blob(parts)); //Create mp3 file from buffer
                    audio.play(); //Play audio
                    document.getElementById("repeat").innerHTML='Get new results by uploading another file.';
                });
            });
            
        </script>
    </body>
</html>
